name: Continuous Deployment

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build & Verify
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Installer PHP (nécessaire si ton site contient du PHP)
      - name: Set up PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1
        with:
          php-version: '8.2'
          extensions: pdo, pdo_mysql, mysqli

      # Vérifier la syntaxe de tous les fichiers PHP
      - name: PHP Lint
        run: |
          find . -name "*.php" -print0 | xargs -0 -n1 php -l

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

  zap-scan:
    name: ZapProxy Security Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Installation de PHP + extensions
      - name: Set up PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1
        with:
          php-version: '8.2'
          extensions: pdo, pdo_mysql, mysqli

      # Créer un index.php de redirection si absent
      - name: Create index.php if not exists
        run: |
          if [ ! -f ./public/index.php ]; then
            echo '<?php header("Location: /login.php"); ?>' > ./public/index.php
          fi

      # Démarrer un serveur PHP local
      - name: Start PHP Server
        run: |
          nohup php -S 127.0.0.1:8080 -t ./public > /tmp/php.log 2>&1 &
          sleep 3
          curl -f http://127.0.0.1:8080/ || (cat /tmp/php.log && exit 1)

      # Scan ZapProxy Baseline (rapide)
      - name: ZapProxy Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://127.0.0.1:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          fail_action: true

      # Scan ZapProxy Full (plus complet, optionnel)
      - name: ZapProxy Full Scan
        if: github.ref == 'refs/heads/main'
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: 'http://127.0.0.1:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

      # Upload des rapports
      - name: Upload ZapProxy Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report
          path: |
            report_md.md
            report_html.html

      # Générér un rapport GitHub Issue si des vulnérabilités sont trouvées
      - name: Create Issue on Vulnerabilities
        if: failure() && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let body = '## ⚠️ ZapProxy Security Scan - Vulnérabilités détectées\n\n';
            if (fs.existsSync('report_md.md')) {
              const report = fs.readFileSync('report_md.md', 'utf8');
              body += report.substring(0, 60000);
            } else {
              body += 'Consultez les artifacts pour le rapport complet.';
            }
            try {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Security: ZapProxy vulnerabilities detected',
                body: body,
                labels: ['security', 'zap-scan']
              });
            } catch(error) {
              console.log('Note: Création d\'issue nécessite des permissions supplémentaires');
            }